<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
<div class="contest">
  <h3>
    <a href="#!contest/{{ id }}">
      {{ name }}
      {{ seatName ? seatName : '' }}
      {{ area ? ' of ' + area : '' }}
      {{ subArea ? subArea : '' }}
    </a>
    {{#if questionTitle}}
      <br> <span class="muted">{{ questionTitle }}</span>
    {{/if}}
  </h3>

  <p class="reporting">
    Reporting {{ precincts }} of {{ totalPrecincts }} precincts.
    {{#if (seats && seats > 1)}}{{ seats }} seats.{{/if}}
    {{#if called}}Called by the Star Tribune.{{/if}}
    {{#if ranked}}Ranked-choice contest ({{ candidates[0].ranks.length }} choices){{/if}}
    {{#if (final && close)}}This race is very close and may need a recount.{{/if}}
    {{#if (!embedded && updatedMoment)}}Last updated {{ updatedMoment.fromNow() }}.{{/if}}
  </p>

  {{#if (!simple && questionText)}}
    <p class="question">{{ questionText }}</p>
  {{/if}}

  <table>
    <thead>
      <tr>
        <th class="canTitle firstOne">Candidate</th>

        {{#if !nonpartisan}}
          <th>Party</th>
        {{/if}}

        {{#if !ranked}}
          <th class="election-table choice">Votes</th>
          <th class="election-table choice">Percent</th>
        {{else}}
          <th class="election-table-header-title choice">Counted</th>
          <th class="election-table choice">1st choice</th>
          <th class="election-table choice">2nd choice</th>
          <th class="election-table choice">3rd choice</th>
        {{/if}}
      <tr>
    </thead>

    <tbody>
      {{#if candidates }}
        {{#each candidates as candidate, ci }}
          {{#if (simple && ci < 3) || !simple}}
            <tr>
              <td class="candidate-name per">
                {{ candidateName(candidate) }}
                {{#if candidate.winner }}
                  <i class="fa fa-check" aria-hidden="true" title="Winner"></i>
                  <span class="sr-only">(is winner)</span>
                {{/if}}
                {{#if candidate.incumbent}}
                  <i class="fa fa-info" aria-hidden="true" title="Incumbent"></i>
                  <span class="sr-only">(is incumbent)</span>
                {{/if}}
              </td>

              {{#if !nonpartisan}}
                <td>{{ candidate.party }}</td>
              {{/if}}

              {{#if !ranked}}
                <td class="candidate-name per">{{ formatVotes(candidate.votes) }}</td>
                <td class="candidate-name per">{{ formatPercent(candidate.percent) }}</td>
              {{else}}
                <td class="candidate-name per">
                  {{#if (candidate.votes && candidate.percent)}}
                    {{ formatVotes(candidate.votes) }} ({{ formatPercent(candidate.percent) }})
                  {{/if}}
                </td>

                <td class="candidate-name per"><span class="totalTally">{{ formatVotes(candidate.ranks[0].votes) }}</span> <span class="perTally">{{ formatPercent(candidate.ranks[0].percent) }}</span></td>
                <td class="candidate-name per"><span class="totalTally">{{ formatVotes(candidate.ranks[1].votes) }}</span> <span class="perTally">{{ formatPercent(candidate.ranks[1].percent) }}</span></td>
                <td class="candidate-name per"><span class="totalTally">{{ formatVotes(candidate.ranks[2].votes) }}</span> <span class="perTally">{{ formatPercent(candidate.ranks[2].percent) }}</span></td>
              {{/if}}
            </tr>
          {{/if}}
        {{/each}}
      {{/if}}
    </tbody>
  </table>
</div>

<script>
import api from '../api.js';
import defaultContest from '../contest-default.js';

export default {
  oncreate: function() {
    // Allow data to set all propeties, since we can't set
    // all from the markup of a component
    this.observe('data', d => {
      if (_.isPlainObject(d)) {
        this.set(defaultContest(d));
      }
    });

    // Look at ID, and see if we should load data
    this.observe('id', d => {
      if (d && !this.get('updated')) {
        this.loadData(d);
      }
    });

    // Poll if not embedded
    if (!this.get('embedded')) {
      this.dataInterval = setInterval(_.bind(this.loadData, this), 30000);
    }
  },

  ondestroy: function() {
    // Note that using a this.set(interval) does not seem to work, maybe
    // the value is destroyed before this is called.
    if (this.dataInterval) {
      clearInterval(this.dataInterval);
    }
  },

  methods: {
    loadData: function(id) {
      id = id || this.get('id');

      if (!id) {
        console.error('No ID provided for contest.');
      }

      api('results', 'contests/' + id || this.get('id'))
        .then(contest => {
          this.set(defaultContest(contest));
        })
        .catch(e => {
          console.error(e);
        });
    }
  },

  computed: {
    updatedMoment(updated, updatedMoment) {
      return updatedMoment && updatedMoment.unix() === updated
        ? updatedMoment
        : updated ? moment.unix(updated) : undefined;
    }
  },

  helpers: {
    candidateName: c => {
      return c.displayName
        ? c.displayName
        : c.writeIn
          ? 'Write-in'
          : _.filter([
            c.title,
            c.prefix,
            c.first,
            c.middle,
            c.nick ? '"' + c.nick + '"' : null,
            c.last,
            c.suffix
          ]).join(' ');
    },

    formatPercent(percent) {
      return _.isNumber(percent)
        ? (Math.round(percent * 100) / 100).toLocaleString() + '%'
        : '';
    },

    formatVotes(votes) {
      return _.isNumber(votes) ? votes.toLocaleString() : '';
    }
  }
};
</script>
